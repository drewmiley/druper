<!DOCTYPE html>
<html>
    <body>
        <h1>DRUPER</h1>
        FILE ONE<input type='file' name='file1' id='file1'/>
        FILE TWO<input type='file' name='file2' id='file2'/>
        <h4>NOTE: FROM IS ONE-BASED</h4>
        <div>
            <h4>KEY</h4>
            From<input type='number' name='key-from' min='1' id='key-from' />
            Length<input type='number' name='key-length' min='1' id='key-length' />
        </div>
        <div>
            <h4>INCLUDE (Supersedes OMIT)</h4>
            From<input type='number' name='include-from' min='1' id='include-from' />
            Length<input type='number' name='include-length' min='1' id='include-length' />
        </div>
        <div>
            <h4>OMIT</h4>
            From<input type='number' name='omit-from' min='1' id='omit-from' />
            Length<input type='number' name='omit-length' min='1' id='omit-length' />
        </div>
        <button id='compare'>Compare</button>
        <div id='result'></div>
        <div id='diff' style='white-space:pre;'></div>
        <div id='onenottwo' style='white-space:pre;'></div>
        <div id='twonotone' style='white-space:pre;'></div>
    </body>
    <script>
        let fileOne;
        let fileTwo;

        document.getElementById('file1').onchange = function() {
            const reader = new FileReader();
            reader.onload = function(progressEvent) {
                fileOne = this.result.split(/\r\n|\n/);
            }
            reader.readAsText(this.files[0]);
        }

        document.getElementById('file2').onchange = function() {
            const reader = new FileReader();
            reader.onload = function(progressEvent) {
                fileTwo = this.result.split(/\r\n|\n/);
            }
            reader.readAsText(this.files[0]);
        }

        const modifiedRecords = fileStrings => {
            let modifiedStrings;
            const includeFrom = parseInt(document.getElementById('include-from').value, 10);
            const includeLength = parseInt(document.getElementById('include-length').value, 10);
            if (includeFrom >= 1 && includeLength >= 1) {
                modifiedStrings = fileStrings.map(d => d.substring(includeFrom - 1, includeFrom + includeLength - 1));
            } else {
                const omitFrom = parseInt(document.getElementById('omit-from').value, 10);
                const omitLength = parseInt(document.getElementById('omit-length').value, 10);
                if (omitFrom >=1 && omitLength >=1) {
                    modifiedStrings = fileStrings.map(d => `${ d.substring(0, omitFrom - 1)}${ d.substring(omitFrom + omitLength - 1) }`);
                }
            }
            return (modifiedStrings || fileStrings).map(d => {
                const keyFrom = parseInt(document.getElementById('key-from').value, 10);
                const keyLength = parseInt(document.getElementById('key-length').value, 10);
                const key = keyFrom >= 1 && keyLength >=1 ? d.substring(keyFrom - 1, keyFrom + keyLength - 1): d;
                return { key, value: d };
            });
        }

        const highlightRecord = (value, comparison) => {
            return value;
        }

        const getDiffRecords = (a, b) => {
            const AnotB = getUniqueRecords(a, b).map(d => d.key);
            const BnotA = getUniqueRecords(b, a).map(d => d.key);
            const diffA = a.filter(d => !AnotB.includes(d.key));
            const diffB = b.filter(d => !BnotA.includes(d.key));
            return diffA.map(recordA => {
                return { key: recordA.key, aValue: recordA.value, bValue: diffB.find(recordB => recordA.key === recordB.key).value };
            }).filter(recordObject => recordObject.aValue !== recordObject.bValue )
                .map(recordObject => `Key: ${ recordObject.key }<br />${ highlightRecord(recordObject.aValue, recordObject.bValue) }<br />${ highlightRecord(recordObject.bValue, recordObject.aValue) }`);
        }

        const getUniqueRecords = (a, b) => {
            let compare = b.map(d => d.key);
            return a.filter(d => {
                const index = compare.indexOf(d.key);
                if (index > -1) {
                    compare.splice(index, 1);
                }
                return index === -1;
            });
        }

        const printToDiv = (selector, initialText, records = [], styles = {}) => {
            const div = document.querySelector(selector);
            div.innerHTML = `<br />${ initialText }<br /><br />`;
            records.forEach(d => div.innerHTML += `${ d }<br />`);
            Object.keys(styles).forEach(key => div.style[key] = styles[key]);
        }

        const compare = () => {
            const recordsOne = modifiedRecords(fileOne);
            const recordsTwo = modifiedRecords(fileTwo);

            const diffRecords = getDiffRecords(recordsOne, recordsTwo);
            printToDiv('#diff', 'Diff', diffRecords);

            const onenottwo = getUniqueRecords(recordsOne, recordsTwo).map(d => d.key);
            printToDiv('#onenottwo', 'In One Not Two', onenottwo);

            const twonotone = getUniqueRecords(recordsTwo, recordsOne).map(d => d.key);
            printToDiv('#twonotone', 'In Two Not One', twonotone);

            const failureRate = (onenottwo.length + twonotone.length + diffRecords.length) /
                Math.max(recordsOne.length, recordsTwo.length);
            const results= [`Records in File One: ${ recordsOne.length }`,
                `Records in File Two: ${ recordsTwo.length }`,
                `Diff Records: ${ diffRecords.length }`,
                `In One Not Two: ${ onenottwo.length }`,
                `In Two Not One: ${ twonotone.length }`,
                `Failure Rate: ${ (100 * failureRate).toString().substr(0, 5) }%`];
            const background = failureRate == 0 ? '#00e600' : (failureRate > 0.005 ? '#ff6666' : 'gold');
            printToDiv('#result', 'Results', results, {background});
        }

        document.getElementById('compare').onclick = compare;
    </script>
</html>
