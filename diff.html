<!DOCTYPE html>
<html>
    <body>
        <h1>DRUPER</h1>
        <input type='file' name='file1' id='file1'/>
        <input type='file' name='file2' id='file2'/>
        <div>
            <h4>KEY</h4>
            From<input type='number' name='key-from' min='0' id='key-from' />
            To<input type='number' name='key-to' min='0' id='key-to' />
        </div>
        <div>
            <h4>INCLUDE (Supersedes OMIT)</h4>
            From<input type='number' name='include-from' min='0' id='include-from' />
            To<input type='number' name='include-to' min='0' id='include-to' />
        </div>
        <div>
            <h4>OMIT</h4>
            From<input type='number' name='omit-from' min='0' id='omit-from' />
            To<input type='number' name='omit-to' min='0' id='omit-to' />
        </div>
        <button id='compare'>Compare</button>
        <div id='result'></div>
        <div id='diff' style='white-space:pre;'></div>
        <div id='onenottwo' style='white-space:pre;'></div>
        <div id='twonotone' style='white-space:pre;'></div>
    </body>
    <script>
        let fileOne;
        let fileTwo;

        document.getElementById('file1').onchange = function() {
            const reader = new FileReader();
            reader.onload = function(progressEvent) {
                fileOne = this.result.split(/\r\n|\n/);
            }
            reader.readAsText(this.files[0]);
        }

        document.getElementById('file2').onchange = function() {
            const reader = new FileReader();
            reader.onload = function(progressEvent) {
                fileTwo = this.result.split(/\r\n|\n/);
            }
            reader.readAsText(this.files[0]);
        }

        const modifiedRecords = fileStrings => {
            let modifiedStrings;
            const includeFrom = parseInt(document.getElementById('include-from').value, 10);
            const includeTo = parseInt(document.getElementById('include-to').value, 10);
            if (includeFrom >=0 && includeTo >=0 && includeTo > includeFrom) {
                modifiedStrings = fileStrings.map(d => d.substring(includeFrom, includeTo));
            } else {
                const omitFrom = parseInt(document.getElementById('omit-from').value, 10);
                const omitTo = parseInt(document.getElementById('omit-to').value, 10);
                if (omitFrom >=0 && omitTo >=0 && omitTo > omitFrom) {
                    modifiedStrings = fileStrings.map(d => `${ d.substring(0, omitFrom)}${ d.substring(omitTo) }`);
                }
            }
            return (modifiedStrings || fileStrings).map(d => {
                const keyFrom = parseInt(document.getElementById('key-from').value, 10);
                const keyTo = parseInt(document.getElementById('key-to').value, 10);
                const key = keyFrom >= 0 && keyTo >=0 && keyTo > keyFrom ? d.substring(keyFrom, keyTo): d;
                return { key, value: d };
            });
        }

        const getDiffRecords = (a, b) => {
            const AnotB = getUniqueRecords(a, b).map(d => d.key);
            const BnotA = getUniqueRecords(b, a).map(d => d.key);
            let diffA = a.filter(d => !AnotB.includes(d.key));
            let diffB = b.filter(d => !BnotA.includes(d.key));
            let result = [];
            for (var i = 0; i < diffA.length; i++) {
                const recordA = diffA[i];
                const recordB = diffB[i];
                if (recordA.value !== recordB.value) {
                    result.push(`Key: ${ recordA.key }\n${ recordA.value }\n${ recordB.value }`);
                }
            }
            return result;
        }

        const getUniqueRecords = (a, b) => {
            let compare = b.map(d => d.key);
            return a.filter(d => {
                const index = compare.indexOf(d.key);
                if (index > -1) {
                    compare.splice(index, 1);
                }
                return index === -1;
            });
        }

        const printToDiv = (selector, initialText, records = [], styles = {}) => {
            const div = document.querySelector(selector);
            div.innerText = `\n${ initialText }\n\n`;
            records.forEach(d => div.innerText += `${ d }\n`);
            Object.keys(styles).forEach(key => div.style[key] = styles[key]);
        }

        const compare = () => {
            const recordsOne = modifiedRecords(fileOne);
            const recordsTwo = modifiedRecords(fileTwo);

            const diffRecords = getDiffRecords(recordsOne, recordsTwo);
            printToDiv('#diff', 'Diff', diffRecords);

            const onenottwo = getUniqueRecords(recordsOne, recordsTwo).map(d => d.key);
            printToDiv('#onenottwo', 'In One Not Two', onenottwo);

            const twonotone = getUniqueRecords(recordsTwo, recordsOne).map(d => d.key);
            printToDiv('#twonotone', 'In Two Not One', twonotone);

            const failureRate = (onenottwo.length + twonotone.length + diffRecords.length) /
                Math.max(recordsOne.length, recordsTwo.length);
            const results= [`Records in File One: ${ recordsOne.length }`,
                `Records in File Two: ${ recordsTwo.length }`,
                `Diff Records: ${ diffRecords.length }`,
                `In One Not Two: ${ onenottwo.length }`,
                `In Two Not One: ${ twonotone.length }`,
                `Failure Rate: ${ failureRate }`];
            const background = failureRate == 0 ? 'green' : (failureRate > 0.005 ? 'red' : 'gold');
            printToDiv('#result', 'Results', results, {background});
        }

        document.getElementById('compare').onclick = compare;
    </script>
</html>
